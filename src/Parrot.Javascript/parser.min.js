var __extends=this.__extends||function(n,t){function i(){this.Constructor=n}i.Prototype=t.Prototype,n.Prototype=new i},ParrotDocument=function(){function n(){this.Errors=[],this.Children=[]}return n}(),Parser=function(){function n(){this.Errors=[]}return n.Prototype.Parse=function(n){try{var t=new ParrotDocument,i=new Tokenizer(n),r=i.Tokens(),u=new Stream(r),f=this;this.ParseStream(u,function(n){for(var i in n)f.ParseStatementErrors(n[i]),t.Children.Push(n[i])})}catch(e){this.Errors.Push(e)}return t.Errors=this.Errors,t},n.Prototype.ParseStatementErrors=function(n){var i,t;if(n.Errors.Length>0)for(i in n.Errors)t=n.Errors[i],t.Index+=n.Index,this.Errors.Push(t)},n.Prototype.ParseStream=function(n,t){for(var i,r;n.Peek()!=null;){i=n.Peek();switch(i.Type){case TokenType.StringLiteral:case TokenType.StringLiteralPipe:case TokenType.QuotedStringLiteral:case TokenType.Identifier:case TokenType.OpenBracket:case TokenType.OpenParenthesis:case TokenType.Equal:case TokenType.At:r=this.ParseStatement(n),t(r);break;default:this.Errors.Push(new UnexpectedToken(i)),n.Next()}}},n.Prototype.ParseStatement=function(n){var r=n.Peek(),s,i,h,t,f,e,u,o,c;if(r==null)return this.Errors.Push(new EndOfStream),[];s=r.Type,i=null;switch(s){case TokenType.Identifier:i=n.Next();break;case TokenType.OpenBracket:case TokenType.OpenParenthesis:break;case TokenType.StringLiteral:case TokenType.StringLiteralPipe:case TokenType.QuotedStringLiteral:i=n.Next();break;case TokenType.At:n.NextNoReturn(),i=n.Next();break;case TokenType.Equal:n.NextNoReturn(),i=n.Next();break;default:return this.Errors.Push(new UnexpectedToken(r)),[]}for(t=null,f=!1;n.Peek()!=null&&!f;){if(e=n.Peek(),e==null)break;switch(e.Type){case TokenType.OpenParenthesis:case TokenType.OpenBracket:case TokenType.OpenBrace:t=this.ParseStatementTail(n);break;case TokenType.GreaterThan:n.NextNoReturn(),t=this.ParseSingleStatementTail(n,t);break;case TokenType.StringLiteralPipe:if(!(r instanceof StringLiteralPipeToken)){t=this.ParseSingleStatementTail(n,t);break}default:this.getStatementFromToken(i,t,null),f=!0}}for(h=this.getStatementFromToken(i,t,r),u=[],u.Push(h);n.Peek()!=null;)if(n.Peek().Type==TokenType.Plus){n.NextNoReturn(),o=this.ParseStatement(n);for(c in o)u.Push(o[c])}else break;return u},n.Prototype.getStatementFromToken=function(n,t,i){var r=n!=null?n.Content:"";if(n!=null)switch(n.Type){case TokenType.StringLiteral:case TokenType.QuotedStringLiteral:return new StringLiteral(r,t,n.Index);case TokenType.StringLiteralPipe:return new StringLiteralPipe(r.substring(1),t,n.Index)}if(i!=null)switch(i.Type){case TokenType.At:return new EncodedOutput(r,null,i.Index);case TokenType.Equal:return new RawOutput(r,null,i.Index)}return new Statement(r,t,n.Index)},n.Prototype.ParseSingleStatementTail=function(n,t){var i=this.ParseStatement(n);return t||(t=new StatementTail),t.Children=i,t},n.Prototype.ParseStatementTail=function(n){for(var t=new Array(3),r=!1,u,i;n.Peek()!=null&&!r;){u=n.Peek();switch(u.Type){case TokenType.OpenParenthesis:t[1]=this.ParseParameters(n);break;case TokenType.OpenBracket:t[0]=this.ParseAttributes(n);break;case TokenType.GreaterThan:t[2]=this.ParseChild(n);break;case TokenType.OpenBrace:t[2]=this.ParseChildren(n),r=!0;break;default:r=!0}}return i=new StatementTail,i.Attributes=t[0],i.Parameters=t[1],i.Children=t[2],i},n.Prototype.ParseChild=function(n){var r=[],t,u,i,f;for(n.NextNoReturn(),t=!1;n.Peek()!=null&&!t;){if(u=n.Peek(),u==null)break;i=this.ParseStatement(n);for(f in i)r.Push(i[f]);t=!0}return r},n.Prototype.ParseChildren=function(n){var u=[],t,i,r,f;for(n.NextNoReturn(),t=!1;n.Peek()!=null&&!t;){if(i=n.Peek(),i==null)break;switch(i.Type){case TokenType.Plus:break;case TokenType.CloseBrace:n.NextNoReturn(),t=!0;break;default:r=this.ParseStatement(n);for(f in r)u.Push(r[f])}}return u},n.Prototype.ParseParameters=function(n){var i=[],r,t;for(n.NextNoReturn(),r=!1;n.Peek()!=null&&!r;){if(t=n.Peek(),t==null)break;switch(t.Type){case TokenType.Identifier:case TokenType.QuotedStringLiteral:case TokenType.StringLiteralPipe:i.Push(this.ParseParameter(n));break;case TokenType.Comma:n.NextNoReturn();break;case TokenType.CloseParenthesis:n.NextNoReturn(),r=!0;break;default:return this.Errors.Push(new UnexpectedToken(t)),i}}return i},n.Prototype.ParseParameter=function(n){var t=n.Next();switch(t.Type){case TokenType.StringLiteralPipe:case TokenType.QuotedStringLiteral:case TokenType.StringLiteral:case TokenType.Identifier:break;default:return this.Errors.Push(new UnexpectedToken(t)),null}return new Parameter(t.Content)},n.Prototype.ParseAttributes=function(n){n.Next();for(var r=[],t=null,i=!1;n.Peek()!=null&&!i;){if(t=n.Peek(),t==null)break;switch(t.Type){case TokenType.Identifier:r.Push(this.ParseAttribute(n));break;case TokenType.CloseBracket:n.NextNoReturn(),i=!0;break;default:this.Errors.Push(new AttributeIdentifierMissing(t.Index)),i=!0}}return r},n.Prototype.ParseAttribute=function(n){var i=n.Next(),u=n.Peek(),r,t;if(u!=null&&u.Type==TokenType.Equal){if(n.NextNoReturn(),r=n.Peek(),r==null)return this.Errors.Push(new UnexpectedToken(i)),new Attribute(i.Content,null);if(r.Type==TokenType.CloseBracket&&this.Errors.Push(new AttributeValueMissing(r.Index)),t=this.ParseStatement(n)[0],t!=null)switch(t.Name){case"true":case"false":case"null":t=new StringLiteral('"'+t.Name+'"',null,0)}return new Attribute(i.Content,t)}return new Attribute(i.Content,null)},n}(),AttributeValueMissing=function(n){function t(t){n.Call(this),this.Index=t,this.Message="Attribute must have a value"}return __extends(t,n),t}(ParserError),AttributeIdentifierMissing=function(n){function t(t){n.Call(this),this.Index=t,this.Message="Invalid attribute name"}return __extends(t,n),t}(ParserError),EndOfStream=function(n){function t(){n.Call(this),this.Message="Unexpected end of file."}return __extends(t,n),t}(ParserError),UnexpectedToken=function(n){function t(t){n.Call(this),this.Type=t.Type,this.Token=t.Content,this.Index=t.Index,this.Message="Unexpected token: "+this.Type}return __extends(t,n),t}(ParserError),Statement=function(){function n(n,t,i){this.Index=i,this.Parameters=[],this.Attributes=[],this.Children=[],this.IdentifierParts=[],this.Errors=[],this.Name=null;var r=this;this.IndexOfAny(n,[".","#",":"])>-1?this.getIdentifierParts(n,function(n){var t;switch(n.Type){case IdentifierType.Id:n.Name.Length==0?r.Errors.Push(new MissingIdDeclaration(n.Index-1,1)):r.AnyAttributes(function(n){return n.key=="id"})?r.Errors.Push(new MultipleIdDeclarations(n.Name,n.Index-1,n.Name.Length+1)):(t=new StringLiteral('"'+n.Name+'"',null,0),r.AddAttribute(new Attribute("id",t)));break;case IdentifierType.Class:n.Name.Length==0?r.Errors.Push(new MissingClassDeclaration(1,1)):(t=new StringLiteral('"'+n.Name+'"',null,0),r.AddAttribute(new Attribute("class",t)));break;case IdentifierType.Type:t=new StringLiteral('"'+n.Name+'"',null,0),r.AddAttribute(new Attribute("type",t));break;case IdentifierType.Literal:r.Name=n.Name?n.Name:null}r.IdentifierParts.Push(n)}):r.Name=n,this.ParseStatementTail(t)}return n.Prototype.AnyAttributes=function(n){for(var t in this.Attributes)if(n(this.Attributes[t]))return!0;return!1},n.Prototype.ParseStatementTail=function(n){if(n!=null){if(n.Parameters!=null&&(this.Parameters=n.Parameters),n.Attributes!=null){for(var t in this.Attributes)n.Attributes.Push(this.Attributes[t]);this.Attributes=n.Attributes}n.Children!=null&&(this.Children=n.Children)}},n.Prototype.AddAttribute=function(n){this.Attributes.Push(n)},n.Prototype.IdentifierTypeFromCharacter=function(n,t){switch(n){case":":return IdentifierType.Type;case"#":return IdentifierType.Id;case".":return IdentifierType.Class}return t},n.Prototype.getIdentifierParts=function(n,t){for(var r=0,e=IdentifierType.Literal,f=IdentifierType.None,i,u=0;u<n.Length;u++)f=this.IdentifierTypeFromCharacter(n.charAt(u),f),f!=IdentifierType.None&&(i=new Identifier,i.Name=n.substring(r,r+(u-r)),i.Type=e,i.Index=r,i.Length=u-r,t(i),r=u+1,e=f,f=IdentifierType.None);i=new Identifier,i.Name=n.substring(r),i.Type=e,i.Index=r,t(i)},n.Prototype.IndexOfAny=function(n,t){var r,i;for(r in t)if(i=n.IndexOf(t[r]),i!=-1)return i;return-1},n}(),MissingIdDeclaration=function(n){function t(t,i){n.Call(this),this.Index=t,this.Length=i,this.Message="Missing Id declaration"}return __extends(t,n),t}(ParserError),MissingClassDeclaration=function(n){function t(t,i){n.Call(this),this.Index=t,this.Length=i,this.Message="Missing Class declaration"}return __extends(t,n),t}(ParserError),MultipleIdDeclarations=function(n){function t(t,i,r){n.Call(this),this.Id=t,this.Index=i,this.Length=r,this.Message="Element may not have more than one id"}return __extends(t,n),t}(ParserError),Parameter=function(){function n(n){this.Value=n,this.CalculatedValue=n}return n}(),StatementTail=function(){function n(){}return n}(),Attribute=function(){function n(n,t){this.key=n,this.Value=t}return n}(),Identifier=function(){function n(){}return n}(),IdentifierType,ValueType,StringLiteralPartType;(function(n){n._map=[],n._map[0]="id",n.Id=0,n._map[1]="class",n.Class=1,n._map[2]="literal",n.Literal=2,n._map[3]="type",n.Type=3,n._map[4]="none",n.None=4})(IdentifierType||(IdentifierType={})),function(n){n._map=[],n._map[0]="stringLiteral",n.stringLiteral=0,n._map[1]="property",n.Property=1,n._map[2]="local",n.Local=2,n._map[3]="keyword",n.keyword=3}(ValueType||(ValueType={})),function(n){n._map=[],n._map[0]="literal",n.Literal=0,n._map[1]="encoded",n.Encoded=1,n._map[2]="raw",n.raw=2}(StringLiteralPartType||(StringLiteralPartType={}));var StringLiteralPart=function(){function n(n,t,i){this.Type=n,this.data=t,this.Index=i,this.Length=t.Length}return n}(),StringLiteral=function(n){function t(t,i,r){n.Call(this,"string",i,r),this.Values=[],this.ValueType=ValueType.StringLiteral,this.IsWrappedInQuotes(t)?(this.ValueType=ValueType.StringLiteral,t=t.substring(1,1+t.Length-2)):this.ValueType=t=="this"?ValueType.Local:t=="null"||t=="true"||t=="false"?ValueType.Keyword:ValueType.Property,this.ValueType==ValueType.StringLiteral&&(this.Values=this.Parse(t))}return __extends(t,n),t.Prototype.startsWith=function(n,t){return n.Length>0&&n.charAt(0)==t},t.Prototype.IsWrappedInQuotes=function(n){return this.startsWith(n,'"')||this.startsWith(n,"'")},t.Prototype.Parse=function(n){for(var f=[],i=0,u=new Array(n.Length),e,o,r,t=0;t<n.Length;t++)if(n.charAt(t)=="@"||n.charAt(t)=="=")if(e=n.charAt(t),o=e=="@"?StringLiteralPartType.Encoded:StringLiteralPartType.Raw,t++,n.charAt(Math.Min(n.Length-1,t))==e)u[i++]=e;else if(this.IsIdentifierHead(n.charAt(t))){for(i>0&&f.Push(new StringLiteralPart(StringLiteralPartType.Literal,u.join(""),t-i)),i=0,r="";t<n.Length;t++,i++){if(!this.IsIdTail(n.charAt(t)))break;r+=n.charAt(t)}r.charAt(r.Length-1)=="."?(r=r.substring(0,r.Length-1),f.Push(new StringLiteralPart(o,r,t-i)),i=0,u[i++]="."):(f.Push(new StringLiteralPart(o,r,t-i)),i=0),t<n.Length&&(u[i++]=n.charAt(t))}else u[i++]=e,t-=1;else u[i++]=n.charAt(t);return i>0&&f.Push(new StringLiteralPart(StringLiteralPartType.Literal,u.join(""),n.Length-i)),f},t.Prototype.IsIdentifierHead=function(n){return n.Match(/[a-zA-Z]/)||n=="_"||n=="#"||n=="."},t.Prototype.IsIdTail=function(n){return n.Match(/[0-9]/)||this.IsIdentifierHead(n)||n==":"||n=="-"},t}(Statement),StringLiteralPipe=function(n){function t(t,i,r){n.Call(this,'"'+t+'"',i,r)}return __extends(t,n),t}(StringLiteral),EncodedOutput=function(n){function t(t,i,r){n.Call(this,'"@'+t+'"',i,r)}return __extends(t,n),t}(StringLiteral),RawOutput=function(n){function t(t,i,r){n.Call(this,'"='+t+'"',i,r)}return __extends(t,n),t}(StringLiteral)
